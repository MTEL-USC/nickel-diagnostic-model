% This script uses Cd as an example to show how to grid GEOTRACES data to AO
% According to the GEOTRACES IDP user agreement, we can not distribute the gridded data directly to AO users
% Therefore, the users should grid their own tracers from IDP to AO
% Before running this script, you should download GEOTRACES Discrete Sample Data (NetCDF format) from: 
% https://www.bodc.ac.uk/geotraces/data/idp2017/
% Then, save the nc file in this folder (AweosomeOCIM_v1.3/data/GEOTRACES_2017_IDP)

clear all; close all;

addpath('/Users/Seth/Desktop/Matlab_Utils_Data/Data/GEOTRACES_IDP_2021/seawater/netcdf/GEOTRACES_IDP2021_Seawater_Discrete_Sample_Data_v1')

% load target grid
load ../../data/ao

% load GEOTRACES data and grid
lat = ncread('GEOTRACES_IDP2021_Seawater_Discrete_Sample_Data_v1.nc','latitude');
lon = ncread('GEOTRACES_IDP2021_Seawater_Discrete_Sample_Data_v1.nc','longitude');
cruise = ncread('GEOTRACES_IDP2021_Seawater_Discrete_Sample_Data_v1.nc','metavar1');
depth = ncread('GEOTRACES_IDP2021_Seawater_Discrete_Sample_Data_v1.nc','var2');
% Choose your own tracer; the number of your tracer can be found in the
% downloaded nc_variables.txt (e.g. for Cd, the number is var70)
Ni = ncread('GEOTRACES_IDP2021_Seawater_Discrete_Sample_Data_v1.nc','var104'); 

cruiseid = sum(double(cruise),1)';

% GP15lat = xlsread('Compiled Ni.xlsx','C2:C843');
% GP15lon = xlsread('Compiled Ni.xlsx','D2:D843'); GP15lon(GP15lon<0)=GP15lon(GP15lon<0)+360;
% GP15depth = xlsread('Compiled Ni.xlsx','E2:E843');
% GP15Ni = xlsread('Compiled Ni.xlsx','H2:H843');
% 
% taralat = [46.48505833	45.266015	43.858725	42.144165	40.40934667	37.85217333	37.02760667	34.773235	33.468925	33.15945167	31.69134	29.44892667	28.10680833	26.585235	25.90531833	25.46202333	25.81526667	25.87475	25.7636	25.81907333	25.843855	25.91666167	25.92239	25.87036833	25.97171167	25.809105	23.84490333	2.598021667	1.446371667	-0.753313333	-3.147488333	-5.347538333	-10.07403	-12.33984	-14.41233667	-16.49553333	-21.298145	-22.9487	-24.357885	-25.83435167	-26.57806333	-27.00935	-27.17664667	-25.640625	-25.619775	-25.15721	-24.68813667	-24.61469833	-24.43536	-24.37803667	-23.65205333	-23.42241833	-23.40090667	-22.692275	-21.74381667	-20.918235	-18.71602	-18.13439667	-18.40817	-18.85557333	-18.78839667	-19.09500667	-19.16210333	-19.16243833	-18.43402167	-16.213285	-14.77455667	-14.01660667	-14.060255	-13.75109167	-13.63935167	-13.41242833	-12.828845	-11.23328667	-8.71892	-8.43197	-6.672166667	-4.223496667	-1.573923333	-0.443591667	1.369126667	1.570146667	2.173808333	3.020106667	3.959395	5.000921667	5.584853333	6.503233333	6.950951667	7.377936667	7.94037	13.03075667	13.7993	23.08210167	25.54108333	28.894595	23.51393667	21.816185	21.12549667	20.506145	19.84361	17.72148667	15.68279333	13.74898333	13.67484833	9.006416667	6.804661667	5.144931667	4.282231667	3.520881667	2.858956667	1.75451	0.87632	0.153205	-0.991718333	-2.057355	-2.755921667	-3.446103333	-4.225916667	-4.98491	-6.141775	-7.883246667	-10.58889833	-17.85683667	-13.40382667	-18.66907	-20.54996	-22.8	-25.45905	-28.10826	-32.95271	-35.61013333	-32.07422	-32.13243	-28.91009	-20.47651	-20.09741	-19.04174	-19.79827	-20.34545	-21.46297	-21.71656	-20.14079	-18.52457	-18.05487	-14.96118	-12.91998	-9.08827	-9.07835	-9.94839	-8.82824	-6.9517	-4.1	-5.17818	-4.6643	-2.6853	-1.32422	0.34004	2.87687	6.46551	7.49085	18.10749	19.56543	21.8169	22.36602	34.84483	35.00746	34.3124	33.42	32.54628	32.3432	32.53748	32.84861	33.02511	32.98327	31.77544	30.70336	30.03814	28.02006	26.64292	25.17594	23.17214	22.10726	24.0614	25.93569	27.96528	29.14297	29.98232	30.87022	32.50848	34.90009	36.86104	38.30848	39.97984	41.40504	42.79269	44.09853	45.22913	45.01027	39.7246	37.82782	33.58526	30.47826	27.56368	25.49018	20.16113	17.04336	14.03931	24.10225	10	8.3	8.01649	7.99027	8	7.96921	7.97366	7.94972	7.96713	8.06235	8.3	24.1853	26.6646	29.74326	36.30661667	38.93748333	43.295	43.54481667	44.12956667	48.42733333	49.30818333	50.16	51.0609	51.51628333	48.11135]';
% taralon = [353.19221	350.0745517	347.5049167	344.346255	341.61701	336.2634983	334.0350983	327.2775367	324.4402417	322.49109	320.5424317	315.0311917	312.8097983	310.2320867	307.4771967	304.81796	302.4310233	299.6511133	297.0128233	295.0144383	292.4088167	289.7595667	286.793995	284.6613267	282.0534733	280.663295	278.0601917	279.424535	276.6161633	274.9298517	273.3206317	271.34315	266.998935	264.8769233	262.9210267	260.922145	255.85963	254.51512	252.0741833	250.9672167	250.4714633	250.6930667	250.6020317	245.4392017	243.12221	238.9795233	235.315515	235.06019	234.4434333	234.33067	229.5401167	225.8095467	227.948205	224.0388483	221.79786	219.4079933	213.29427	206.5850417	204.2363233	199.8907417	200.58534	194.2829467	190.4956567	190.226035	189.9135767	189.2409983	188.827735	188.1375383	188.3084283	186.6616633	185.6688267	183.9504483	183.2267367	181.72018	179.28558	179.1140867	177.922755	176.40777	174.6181767	173.8145283	172.9404967	172.3653917	170.4257317	167.4140283	164.179755	160.7064967	158.6055817	155.4048267	153.9166033	152.4021167	151.5040533	144.8298183	144.5383033	141.3278783	141.8485383	137.5262183	123.5901617	124.570695	127.1996483	129.5186767	131.5912733	135.4270933	136.8562383	137.8205533	137.8345517	140.5022233	141.5360267	143.5314667	145.6939683	147.7044267	149.8667583	151.6805983	153.3601567	155.531925	157.6070633	159.8681433	162.2715183	164.6618017	167.2934933	169.9466017	172.0740567	174.00569	174.40299	177.055775	174.8551317	178.09544	177.56602	176.3	176.1137667	177.18411	176.69037	174.7860167	160.8412	158.37648	153.85942	151.23529	153.9175	157.88379	159.35919	161.96159	164.70171	165.44652	163.69394	162.78828	162.45775	161.91431	161.51549	159.52013	154.6257	151.92763	153.01691	152.76743	151.74667	150.20674	148.7711	144.13127	139.93388	133.90869	131.69461	133.50044	134.26881	112.13645	114.24291	115.99557	119.00423	148.20996	152.08534	159.23196	162.36661	165.79514	168.0838	171.12587	174.42647	177.64308	180.87915	186.6922	189.89233	192.90237	194.37163	196.67307	199.01781	200.94492	203.41933	204.91737	207.01642	208.53838	210.39128	212.75201	215.19551	217.02911	217.65781	217.40071	219.12885	221.87801	224.48042	227.4397	230.2468	232.97445	234.45776	233.51869	235.96867	240.20852	243.33561	243.5605	244.89855	250.27805	250.49187	250.61292	247.52572	252.9	258.2	261.01555	264.04831	266.7	269.71947	272.50031	274.9393	276.05273	280.32199	258.2	277.18966	280.99128	281.86761	285.7788333	286.8291	295.70845	299.66425	303.3850667	334.5495833	339.0655167	343.4836167	348.7542	351.6732	355.2454]';
% tarani = [2.879439208	2.741307024	2.6098147	2.579660536	2.518256945	2.484276109	2.410246542	2.348193928	2.290466455	2.255727888	2.277723276	2.251018446	2.219005153	2.193826251	2.200902095	2.233181361	2.169928951	2.129160971	2.247992982	2.255716605	2.464903251	2.249312707	2.417858811	2.515274197	2.185735543	2.165652057	2.229263796	2.385916887	2.530397487	2.458986801	3.553623651	3.328816074	2.924429212	2.833976337	2.928171305	2.953821596	2.742293266	2.645376333	2.589671672	2.49277271	2.4655937	2.437528983	2.434483126	2.358239712	2.499964604	2.318137664	2.322707572	2.232810534	2.294317451	1.830709082	2.328029905	2.327508625	2.295645934	1.879543895	1.953661818	2.514828351	2.432670077	1.967294639	1.933607792	1.89491528	1.883876269	1.926797157	1.801584531	1.840447691	1.836841835	1.904364896	1.802494411	2.858624093	2.497425774	1.792442667	2.013262924	1.843403939	1.817057959	1.842199361	1.864085601	1.850933034	1.913256994	2.443774147	2.419935814	1.946710122	1.90390842	2.916233529	1.902079848	2.018183801	1.791004627	1.813334016	1.861386981	1.806657694	2.273109411	1.855639709	2.304859236	1.824790085	2.3132685	2.284044263	2.250229898	2.335722505	2.338174115	2.29546064	2.294833829	2.367145436	2.341040431	2.300671977	2.314261322	2.308184171	2.284330749	2.554441118	2.658155735	2.327823693	2.533138972	2.274233525	2.266648743	2.319203515	2.329884002	2.236142525	2.277073339	2.337935102	2.35234479	2.214760659	2.296101658	2.311145042	2.227487228	2.184525783	2.077251496	2.020199904	2.153773686	2.127684647	2.099284607	2.096400977	2.194264297	2.189103799	2.2364003	2.554784462	2.268149737	2.31821352	2.179162307	2.146799983	2.165019359	2.162832215	2.153002243	2.112357535	2.769787951	2.576496069	2.247819854	2.231869558	2.231653182	2.184126006	2.119466302	2.112531218	2.185657665	2.12222849	2.318754142	2.127095221	2.056891986	1.879314723	2.133255764	2.217712763	2.637784359	2.520932938	2.534914443	2.396262039	2.281123603	2.797509283	2.756176855	2.898433426	2.46389903	2.143357366	2.331556205	2.292068393	2.466999929	2.384371074	2.381228573	2.523756848	2.206462019	2.452000884	2.20231559	2.421326724	2.413258463	2.425562288	2.319581443	2.489316022	2.525225146	2.475171237	2.487249296	2.300879661	2.353758035	2.324783111	2.385367991	2.479838001	2.363972008	2.394554662	2.857600913	3.17110292	3.225425247	3.419057808	3.56284211	3.778131425	3.033908991	3.699269805	4.008507049	3.627420547	3.75475258	3.28075801	3.158617879	3.36644368	3.133822491	3.371358861	1.830599207	2.465462251	3.27555789	2.349554142	2.415533672	2.569044924	2.823340957	2.385808705	2.174317259	2.240219319	2.537730106	2.554680354	2.925436346	2.094457188	2.018364159	2.544960746	2.141765357	4.775240559	3.561025727	5.216707519	3.610412488	4.061734719	3.000927158	2.360778576	2.578958919	2.497793336	3.370738633	3.133723126]';
% taradepth = ones(size(tarani))*5;
% 
% % taralat = [];
% % taralon = [];
% % tarani = [];
% % taradepth = ones(size(tarani))*5;
% 
% 

% GEOTRACES dimensions
nstations = size(cruise,2);
nsample = size(depth,1);
ntotal = nstations*nsample;

% repeat lat and lon
lat = repmat(lat',[nsample,1]);
lon = repmat(lon',[nsample,1]); 

% find datapoints
Icd = find(~isnan(Ni)&~isnan(depth));

% reshape into vectors
lat = lat(Icd);
lon = lon(Icd);
depth = depth(Icd);
Ni = Ni(Icd);

% lat = [lat;GP15lat;taralat];
% lon = [lon;GP15lon;taralon];
% depth = [depth;GP15depth;taradepth];
% Ni = [Ni;GP15Ni;tarani];

% note, the bin3d code doesn't seem to be able to deal with data along the
% zero meridion, therefore change all values between 359 to 360 and 0 to 1
% to be exactly 1
lon(lon>359)=1; lon(lon<1)=1;

% estimated measurement error
Cderr = Ni*.05;

% grid data
[GTCd,GTvarCd,GTnCd,Q] = bin3d(lon,lat,depth,Ni,Cderr,ao.LON,ao.LAT,ao.DEPTH);

% replace missing values with NaN, instead of -9
GTCd(GTCd==-9)=NaN;
GTvarCd(GTvarCd==-9)=NaN;
GTCd(ao.OCN==0)=NaN;

GT_IDP21_Ni = GTCd;

save ('GT_IDP21_Ni.mat', 'GT_IDP21_Ni')